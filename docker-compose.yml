version: '3.8'
services:
  app:
    build: .
    ports:
      - "8000:8000"
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    volumes:
      - ./:/app
      - ./data/uploads:/app/data/uploads
      - ./outputs:/app/outputs
    restart: unless-stopped

  n8n:
    image: n8nio/n8n:latest
    ports:
      - "5678:5678"
    environment:
      - N8N_BASIC_AUTH_ACTIVE=false
    volumes:
      - ./n8n:/home/node/.n8n
      # Make uploads visible to n8n so it can save directly to the shared uploads folder
      - ./data/uploads:/data/uploads
    restart: unless-stopped

  comfyui:
    build:
      context: .
      dockerfile: services/comfyui/Dockerfile
    ports:
      - "8188:8188"
    volumes:
      - ./comfyui:/comfyui
    environment:
      - COMFYUI_MODE=cpu
    profiles:
      - comfyui
    restart: unless-stopped

# Usage:
# - Standard demo: `docker compose up --build` (starts app and n8n)
# - To include the optional ComfyUI service: `docker compose --profile comfyui up --build`
